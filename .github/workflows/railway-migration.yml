name: ğŸ”„ Railway Migration Pipeline

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Pipeline action'
        required: true
        default: 'migrate'
        type: choice
        options:
        - migrate
        - rollback
        - validate-only
      force:
        description: 'Force migration (auto-fix issues)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  pre-migration:
    name: ğŸ” Pre-Migration Validation
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'rollback'
    outputs:
      validation-passed: ${{ steps.validate.outputs.passed }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ Build validation
        run: pnpm run build

      - name: ğŸ” Validate project structure
        run: |
          echo "ğŸ” Validating monorepo structure..."
          test -d apps/api || { echo "âŒ apps/api missing"; exit 1; }
          test -d apps/web || { echo "âŒ apps/web missing"; exit 1; }
          test -d apps/admin || { echo "âŒ apps/admin missing"; exit 1; }
          test -f package.json || { echo "âŒ package.json missing"; exit 1; }
          test -f pnpm-workspace.yaml || { echo "âŒ pnpm-workspace.yaml missing"; exit 1; }
          echo "âœ… Project structure valid"

      - name: ğŸ” Validate configuration
        run: |
          echo "ğŸ” Validating pipeline configuration..."
          test -f pipeline/config.json || { echo "âŒ pipeline/config.json missing"; exit 1; }
          echo "âœ… Configuration valid"

      - name: âœ… Set validation result
        id: validate
        run: echo "passed=true" >> $GITHUB_OUTPUT

  railway-setup:
    name: ğŸš‚ Railway Setup
    runs-on: ubuntu-latest
    needs: pre-migration
    if: |
      github.event.inputs.action == 'migrate' && 
      needs.pre-migration.outputs.validation-passed == 'true'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install Railway CLI
        run: npm install -g @railway/cli

      - name: ğŸ” Railway Login
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ğŸ” Authenticating with Railway..."
          railway login --token $RAILWAY_TOKEN

      - name: ğŸš€ Initialize Railway Project
        run: |
          echo "ğŸš€ Initializing Railway project..."
          railway init --name soil-business

      - name: ğŸ”— Connect GitHub Repository
        run: |
          echo "ğŸ”— Connecting GitHub repository..."
          railway connect

      - name: ğŸ—„ï¸ Add PostgreSQL Database
        run: |
          echo "ğŸ—„ï¸ Adding PostgreSQL database..."
          railway add postgresql || echo "âš ï¸ Database may already exist"

      - name: âš™ï¸ Configure Environment Variables
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "âš™ï¸ Setting up environment variables..."
          railway variables set NODE_ENV=production
          railway variables set JWT_SECRET="${JWT_SECRET:-$(openssl rand -base64 64)}"

  migrate-services:
    name: ğŸš€ Migrate Services
    runs-on: ubuntu-latest
    needs: railway-setup
    if: github.event.inputs.action == 'migrate'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install Railway CLI
        run: npm install -g @railway/cli

      - name: ğŸ” Railway Login
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway login --token $RAILWAY_TOKEN

      - name: ğŸš€ Deploy Services
        run: |
          echo "ğŸš€ Deploying all services to Railway..."
          railway up --detach

      - name: â³ Wait for deployment stabilization
        run: |
          echo "â³ Waiting for services to stabilize..."
          sleep 120  # Wait 2 minutes

      - name: ğŸ“Š Check deployment status
        run: |
          echo "ğŸ“Š Checking Railway deployment status..."
          railway status

  validate-deployment:
    name: âœ… Validate Deployment
    runs-on: ubuntu-latest
    needs: migrate-services
    if: github.event.inputs.action == 'migrate'
    steps:
      - name: ğŸ§ª Health Check API
        run: |
          echo "ğŸ§ª Testing API health..."
          max_retries=10
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            if curl -f https://soil-business-api.railway.app/health; then
              echo "âœ… API health check passed"
              break
            else
              echo "â³ API not ready, retrying in 30s... ($((retry_count+1))/$max_retries)"
              sleep 30
              retry_count=$((retry_count+1))
            fi
          done
          
          if [ $retry_count -eq $max_retries ]; then
            echo "âŒ API health check failed after $max_retries attempts"
            exit 1
          fi

      - name: ğŸ§ª Health Check Web App
        run: |
          echo "ğŸ§ª Testing Web application..."
          curl -f https://soil-business-web.railway.app/ || {
            echo "âŒ Web app health check failed"
            exit 1
          }
          echo "âœ… Web app health check passed"

      - name: ğŸ§ª Health Check Admin Dashboard
        run: |
          echo "ğŸ§ª Testing Admin dashboard..."
          curl -f https://soil-business-admin.railway.app/admin || {
            echo "âŒ Admin dashboard health check failed"
            exit 1
          }
          echo "âœ… Admin dashboard health check passed"

      - name: ğŸ§ª Functional Tests
        run: |
          echo "ğŸ§ª Running functional tests..."
          
          # Test API auth endpoint
          echo "Testing API auth endpoint..."
          curl -X POST https://soil-business-api.railway.app/auth/request-otp \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com"}' || {
            echo "âš ï¸ API auth test failed (may be expected)"
          }
          
          echo "âœ… Basic functional tests completed"

  rollback:
    name: ğŸ”„ Rollback
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'rollback'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install Railway CLI
        run: npm install -g @railway/cli

      - name: ğŸ” Railway Login
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway login --token $RAILWAY_TOKEN

      - name: ğŸ”„ Execute Rollback
        run: |
          echo "ğŸ”„ Starting rollback procedure..."
          
          # List current deployments
          railway status
          
          echo "âš ï¸ Manual intervention required for complete rollback"
          echo "ğŸ“‹ Actions needed:"
          echo "  1. Delete Railway project from dashboard"
          echo "  2. Restore Vercel configuration"
          echo "  3. Reconfigure Vercel deployment"

  notification:
    name: ğŸ“¢ Pipeline Results
    runs-on: ubuntu-latest
    needs: [pre-migration, railway-setup, migrate-services, validate-deployment, rollback]
    if: always()
    steps:
      - name: ğŸ“Š Success Summary
        if: |
          github.event.inputs.action == 'migrate' && 
          needs.validate-deployment.result == 'success'
        run: |
          echo "ğŸ‰ RAILWAY MIGRATION SUCCESSFUL!"
          echo "================================"
          echo ""
          echo "ğŸ”— Your applications are now live:"
          echo "   ğŸ”— API: https://soil-business-api.railway.app/"
          echo "   ğŸŒ Web: https://soil-business-web.railway.app/"
          echo "   âš™ï¸ Admin: https://soil-business-admin.railway.app/"
          echo ""
          echo "ğŸ“Š Railway Dashboard: https://railway.app/dashboard"
          echo "ğŸ’° Estimated cost: ~$5/month"
          echo ""
          echo "ğŸŠ Migration completed successfully!"

      - name: ğŸ“Š Failure Summary
        if: |
          github.event.inputs.action == 'migrate' && 
          (needs.validate-deployment.result == 'failure' || 
           needs.migrate-services.result == 'failure' ||
           needs.railway-setup.result == 'failure')
        run: |
          echo "âŒ RAILWAY MIGRATION FAILED"
          echo "============================"
          echo ""
          echo "ğŸ”§ Check the logs above for specific errors"
          echo "ğŸ”„ You can:"
          echo "   1. Fix the issues and re-run the migration"
          echo "   2. Run rollback to restore previous state"
          echo ""
          echo "ğŸ“ Support: https://help.railway.app"

      - name: ğŸ“Š Rollback Summary
        if: github.event.inputs.action == 'rollback'
        run: |
          echo "ğŸ”„ ROLLBACK INITIATED"
          echo "===================="
          echo ""
          echo "âš ï¸ Manual steps required:"
          echo "   1. Complete Railway project cleanup"
          echo "   2. Restore Vercel configuration"
          echo "   3. Test Vercel deployment"

      - name: ğŸ“Š Validation-Only Summary
        if: |
          github.event.inputs.action == 'validate-only' && 
          needs.pre-migration.result == 'success'
        run: |
          echo "âœ… VALIDATION SUCCESSFUL"
          echo "======================="
          echo ""
          echo "ğŸš€ Your project is ready for Railway migration!"
          echo "Run the migration action when ready."